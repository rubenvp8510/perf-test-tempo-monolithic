apiVersion: rbac.authorization.k8s.io/v1
kind: Role
metadata:
  name: prometheus-k8s
  namespace: tempo-perf-test
  labels:
    app.kubernetes.io/component: prometheus
    app.kubernetes.io/instance: k8s
    app.kubernetes.io/name: prometheus
    app.kubernetes.io/part-of: kube-prometheus
    app.kubernetes.io/version: 2.36.2
rules:
  - apiGroups:
      - ""
    resources:
      - services
      - endpoints
      - pods
    verbs:
      - get
      - list
      - watch
  - apiGroups:
      - extensions
    resources:
      - ingresses
    verbs:
      - get
      - list
      - watch
  - apiGroups:
      - networking.k8s.io
    resources:
      - ingresses
    verbs:
      - get
      - list
      - watch
---
apiVersion: rbac.authorization.k8s.io/v1
kind: RoleBinding
metadata:
  labels:
    app.kubernetes.io/component: prometheus
    app.kubernetes.io/instance: k8s
    app.kubernetes.io/name: prometheus
    app.kubernetes.io/part-of: kube-prometheus
    app.kubernetes.io/version: 2.36.2
  name: prometheus-k8s
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: Role
  name: prometheus-k8s
subjects:
  - kind: ServiceAccount
    name: prometheus-k8s
    namespace: monitoring
---
apiVersion: monitoring.coreos.com/v1
kind: PodMonitor
metadata:
  name: query-load-generator
  namespace: tempo-perf-test
spec:
  namespaceSelector: {}
  selector:
    matchLabels:
      app: query-load-generator
  podMetricsEndpoints:
    - port: metrics
      interval: 2s
---
apiVersion: v1
kind: ServiceAccount
metadata:
  name: query-load-account
  namespace: tempo-perf-test
---
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRoleBinding
metadata:
  name: admin-sa-binding
  namespace: tempo-perf-test
subjects:
  - kind: ServiceAccount
    name: query-load-account
    namespace: tempo-perf-test
roleRef:
  kind: ClusterRole
  name: cluster-admin
  apiGroup: rbac.authorization.k8s.io
---
# Grant the query-load-account Service Account permission to read traces from the 'tenant-1' tenant
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRole
metadata:
  name: allow-read-traces-tenant-1
rules:
- apiGroups: [tempo.grafana.com]
  resources: [tenant-1]  # tenantName
  resourceNames: [traces]
  verbs: [get]
---
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRoleBinding
metadata:
  name: allow-read-traces-tenant-1
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: ClusterRole
  name: allow-read-traces-tenant-1
subjects:
- kind: ServiceAccount
  name: query-load-account
  namespace: tempo-perf-test
---
# Grant the query-load-account ServiceAccount view permissions of the tempo-perf-test namespace.
# If the ServiceAccount cannot access any namespaces, every 'get' request will be denied:
# https://github.com/observatorium/opa-openshift/pull/18/files
apiVersion: rbac.authorization.k8s.io/v1
kind: RoleBinding
metadata:
  name: view-namespace-tenant-1
  namespace: tempo-perf-test
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: ClusterRole
  name: view
subjects:
- kind: ServiceAccount
  name: query-load-account
  namespace: tempo-perf-test
---
apiVersion: v1
kind: ConfigMap
metadata:
  name: query-load-config
  namespace: tempo-perf-test
data:
  config.yaml: |
    tempo:
      queryEndpoint: "https://tempo-simplest-gateway:8080"

    namespace: "tempo-perf-test"
    tenantId: "tenant-1"

    query:
      delay: "5s"
      concurrentQueries: 5

    timeBuckets:
      - name: "recent"
        ageStart: "30s"
        ageEnd: "2m"
        weight: 20
      - name: "ingester"
        ageStart: "5m"
        ageEnd: "15m"
        weight: 30
      - name: "backend-1h"
        ageStart: "1h"
        ageEnd: "2h"
        weight: 50

    queries:
      # Simple Resource Queries
      - name: "resource_service_loadtest"
        traceql: '{ resource.service.name = "frontend" }'
      - name: "resource_service_frontend"
        traceql: '{ resource.service.name = "frontend" }'
      - name: "resource_service_api_gateway"
        traceql: '{ resource.service.name = "api-gateway" }'

      # Span Attribute Queries
      - name: "span_http_get"
        traceql: '{ span.http.method = "GET" }'
      - name: "span_http_post"
        traceql: '{ span.http.method = "POST" }'
      - name: "span_http_status_error"
        traceql: '{ span.http.status_code >= 400 }'

      # Duration Intrinsic Queries
      - name: "duration_gt_100ms"
        traceql: '{ duration > 100ms }'
      - name: "duration_gt_500ms"
        traceql: '{ duration > 500ms }'
      - name: "duration_gt_1s"
        traceql: '{ duration > 1s }'
      - name: "duration_range_100ms_500ms"
        traceql: '{ duration > 100ms && duration < 500ms }'

      # Status Intrinsic Queries
      - name: "status_error"
        traceql: '{ status = error }'
      - name: "status_ok"
        traceql: '{ status = ok }'

      # Kind Intrinsic Queries
      - name: "kind_server"
        traceql: '{ kind = server }'
      - name: "kind_client"
        traceql: '{ kind = client }'

      # Structural Queries - Parent-Child
      - name: "struct_frontend_to_api"
        traceql: '{ resource.service.name = "frontend" } >> { resource.service.name = "api-gateway" }'
      - name: "struct_service_to_error"
        traceql: '{ resource.service.name = "frontend" } >> { status = error }'
      - name: "struct_get_to_slow"
        traceql: '{ span.http.method = "GET" } >> { duration > 500ms }'

      # Structural Queries - Sibling
      - name: "struct_sibling_get_post"
        traceql: '{ span.http.method = "GET" } ~ { span.http.method = "POST" }'

      # Complex Logic Queries
      - name: "logic_service_and_slow"
        traceql: '{ resource.service.name = "frontend" && duration > 500ms }'
      - name: "logic_post_and_slow"
        traceql: '{ span.http.method = "POST" && duration > 200ms }'
      - name: "logic_or_services"
        traceql: '{ resource.service.name = "frontend" || resource.service.name = "api-gateway" }'

      # Negation Queries
      - name: "negation_not_options"
        traceql: '{ span.http.method != "OPTIONS" }'
      - name: "negation_not_ok"
        traceql: '{ status != ok }'

      # Aggregate Select Queries
      - name: "select_http_status"
        traceql: '{ } | select(span.http.status_code)'
      - name: "select_duration"
        traceql: '{ duration > 100ms } | select(duration)'

      # Combined Complex Queries
      - name: "complex_service_slow_error"
        traceql: '{ resource.service.name = "order-service" && duration > 1s && status = error }'
      - name: "complex_struct_with_duration"
        traceql: '{ resource.service.name = "frontend" && duration < 100ms } >> { duration > 500ms }'
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: query-load-generator
  namespace: tempo-perf-test
  labels:
    app: query-load-generator
spec:
  replicas: 1
  selector:
    matchLabels:
      app: query-load-generator
  template:
    metadata:
      labels:
        app: query-load-generator
    spec:
      serviceAccountName: query-load-account
      containers:
        - name: app
          image: quay.io/rvargasp/query-load-generator:latest
          imagePullPolicy: Always
          volumeMounts:
            - mountPath: /config
              name: config
              readOnly: true
          ports:
            - containerPort: 2112
              name: metrics
          env:
            - name: CONFIG_FILE
              value: /config/config.yaml
      volumes:
        - name: config
          configMap:
            name: query-load-config

